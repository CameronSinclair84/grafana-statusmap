{"version":3,"sources":["../src/annotations.js"],"names":["d3","$","_","kbn","TOOLTIP_PADDING_X","TOOLTIP_PADDING_Y","AnnotationTooltip","elem","scope","dashboard","ctrl","panelCtrl","panel","mouseOverAnnotationTick","on","onMouseOver","bind","onMouseLeave","e","tooltip","show","data","isEmpty","add","move","destroy","tooltipBase","select","append","attr","style","remove","pos","annoId","target","anno","annotations","annoTitle","tooltipTimeFormat","annoTime","formatDate","time","annoText","text","annoTags","tags","map","t","tooltipHtml","join","backColor","borderColor","html","node","tooltipWidth","clientWidth","tooltipHeight","clientHeight","left","pageX","top","pageY","window","innerWidth","pageYOffset","innerHeight"],"mappings":"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","file":"annotations.js","sourcesContent":["import d3 from 'd3';\r\nimport $ from 'jquery';\r\nimport _ from 'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\n\r\nlet TOOLTIP_PADDING_X = 30;\r\nlet TOOLTIP_PADDING_Y = 10;\r\n\r\nexport class AnnotationTooltip {\r\n  constructor(elem, scope) {\r\n    this.scope = scope;\r\n    this.dashboard = scope.ctrl.dashboard;\r\n    this.panelCtrl = scope.ctrl;\r\n    this.panel = scope.ctrl.panel;\r\n    this.mouseOverAnnotationTick = false;\r\n\r\n    elem.on(\"mouseover\", this.onMouseOver.bind(this));\r\n    elem.on(\"mouseleave\", this.onMouseLeave.bind(this));\r\n  }\r\n\r\n  onMouseOver(e) {\r\n    if (!this.panel.tooltip.show || !this.scope.ctrl.data || _.isEmpty(this.scope.ctrl.data)) { return; }\r\n\r\n    if (!this.tooltip) {\r\n      this.add();\r\n      this.move(e);\r\n    }\r\n  }\r\n\r\n  onMouseLeave() {\r\n    this.destroy();\r\n  }\r\n\r\n  onMouseMove(e) {\r\n    if (!this.panel.tooltip.show) { return; }\r\n\r\n    this.move(e);\r\n  }\r\n\r\n  add() {\r\n    this.tooltipBase = d3.select(\"body\")\r\n    .append(\"div\")\r\n    .attr(\"class\", \"statusmap-annotation-tooltip drop drop-popover drop-popover--annotation drop-element drop-enabled drop-target-attached-center drop-open drop-open-transitionend drop-after-open\")\r\n    .style(\"position\", \"absolute\")\r\n    this.tooltip = this.tooltipBase\r\n      .append(\"div\")\r\n      .attr(\"class\", \"drop-content\")\r\n      .append(\"div\")\r\n      .append(\"annotation-tooltip\")\r\n      .append(\"div\")\r\n      .attr(\"class\", \"graph-annotation\");\r\n  }\r\n\r\n  destroy() {\r\n    if (this.tooltip) {\r\n      this.tooltip.remove();\r\n    }\r\n\r\n    this.tooltip = null;\r\n\r\n    if (this.tooltipBase) {\r\n      this.tooltipBase.remove();\r\n    }\r\n\r\n    this.tooltipBase = null;\r\n\r\n  }\r\n\r\n  show(pos) {\r\n    if (!this.panel.tooltip.show || !this.tooltip) { return; }\r\n    // shared tooltip mode\r\n    //if (pos.panelRelY) {\r\n    //  return;\r\n    //}\r\n\r\n    let annoId = d3.select(pos.target).attr('annoId');\r\n    if (!annoId) {\r\n      this.destroy();\r\n      return;\r\n    }\r\n\r\n    let anno = this.panelCtrl.annotations[annoId];\r\n    if (!anno) {\r\n      this.destroy();\r\n      return;\r\n    }\r\n\r\n    let annoTitle = \"\";\r\n\r\n    let tooltipTimeFormat = 'YYYY-MM-DD HH:mm:ss';\r\n    let annoTime = this.dashboard.formatDate(anno.time, tooltipTimeFormat);\r\n    let annoText = anno.text;\r\n    let annoTags = [];\r\n    if (anno.tags) {\r\n      annoTags = _.map(anno.tags, t => ({\"text\": t, \"backColor\": \"rgb(63, 43, 91)\", \"borderColor\":\"rgb(101, 81, 129)\"}))\r\n    }\r\n\r\n    let tooltipHtml = `<div class=\"graph-annotation__header\">\r\n      <span class=\"graph-annotation__title\">${annoTitle}</span>\r\n    <span class=\"graph-annotation__time\">${annoTime}</span></div>\r\n    <div class=\"graph-annotation__body\">\r\n      <div>${annoText}</div>\r\n      ${_.join(_.map(annoTags, t => `<span class=\"label label-tag small\" style=\"background-color: ${t.backColor}; border-color: ${t.borderColor}\">${t.text}</span>`), \"\")}\r\n    </div>\r\n      <div class=\"statusmap-histogram\"></div>`;\r\n\r\n    this.tooltip.html(tooltipHtml);\r\n\r\n    this.move(pos);\r\n  }\r\n\r\n  move(pos) {\r\n    if (!this.tooltipBase) { return; }\r\n\r\n    let elem = $(this.tooltipBase.node())[0];\r\n    let tooltipWidth = elem.clientWidth;\r\n    let tooltipHeight = elem.clientHeight;\r\n\r\n    let left = pos.pageX - tooltipWidth/2;\r\n    let top = pos.pageY + TOOLTIP_PADDING_Y;\r\n\r\n    if (pos.pageX + tooltipWidth/2 + 10 > window.innerWidth) {\r\n      left = pos.pageX - tooltipWidth - TOOLTIP_PADDING_X;\r\n    }\r\n\r\n    if (pos.pageY - window.pageYOffset + tooltipHeight + 20 > window.innerHeight) {\r\n      top = pos.pageY - tooltipHeight - TOOLTIP_PADDING_Y;\r\n    }\r\n\r\n    return this.tooltipBase\r\n      .style(\"left\", left + \"px\")\r\n      .style(\"top\", top + \"px\");\r\n  }\r\n}\r\n"]}