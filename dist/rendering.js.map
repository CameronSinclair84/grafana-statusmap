{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","cardsData","timeRange","panel","heatmap","$heatmap","find","tooltip","StatusHeatmapTooltip","annotationTooltip","AnnotationTooltip","width","height","yScale","xScale","chartWidth","chartHeight","chartTop","chartBottom","yAxisWidth","xAxisHeight","cardVSpacing","cardHSpacing","cardRound","cardWidth","cardHeight","colorScale","opacityScale","mouseUpHandler","xGridSize","yGridSize","yOffset","selection","active","x1","x2","padding","left","right","top","bottom","margin","dataRangeWidingFactor","DATA_RANGE_WIDING_FACTOR","events","on","render","setElementHeight","row","_","isString","parseInt","replace","legend","show","css","e","getYAxisWidth","axis_text","selectAll","nodes","max_text_width","max","map","text","getBBox","Math","ceil","getXAxisHeight","axis_line","select","empty","axis_line_position","parseFloat","attr","canvas_width","addXAxis","d3","scaleTime","domain","from","to","range","ticks","DEFAULT_X_TICK_SIZE_PX","grafanaTimeFormatter","grafanaTimeFormat","timeFormat","dashboardTimeZone","dashboard","getTimezone","utcFormat","xAxis","axisBottom","tickFormat","tickPadding","X_AXIS_TICK_PADDING","tickSize","posY","posX","append","call","remove","getYScale","step","length","push","i","scaleOrdinal","getYAxisScale","addYAxis","uniq","d","target","isEmpty","yAxisSort","sort","a","b","localeCompare","ignorePunctuation","numeric","yAxisScale","yAxis","axisLeft","tickValues","tickSizeInner","Y_AXIS_TICK_PADDING","wideYAxisRange","min","tickInterval","y_widing","y_min","y_max","floor","tickValueFormatter","decimals","scaledDecimals","format","value","kbn","valueFormats","addHeatmapCanvas","heatmap_elem","cards","CARD_H_SPACING","CARD_V_SPACING","CARD_ROUND","yBucketSize","xBucketSize","style","addHeatmap","maxValue","color","minValue","mode","getColorScale","setOpacityScale","enter","c","id","getCardX","getCardWidth","getCardY","getCardHeight","getCardColor","getCardOpacity","$cards","event","mouseOverBucket","highlightCard","resetCardHighLight","_renderAnnotations","emit","highlightColor","darker","strokeColor","brighter","current_card","originalFillColor","colorScheme","colorSchemes","colorInterpolator","d3ScaleChromatic","colorScaleInverted","invert","contextSrv","user","lightTheme","start","end","scaleSequential","scaleLinear","scalePow","exponent","x","cx","w","cutted_width","MIN_CARD_SIZE","y","ys","h","cardColor","discreteHelper","getBucketColor","values","nullPointMode","getCardStrokeWidth","appEvents","drawSharedCrosshair","pos","clearCrosshair","onMouseDown","offsetX","onMouseUp","$","document","one","unbind","selectionRange","abs","MIN_SELECTION_WIDTH","timeFrom","timeTo","timeSrv","setTime","moment","utc","clearSelection","onMouseLeave","onMouseMove","destroy","limitSelection","drawSelection","emitGraphHoverEvet","drawCrosshair","valueOf","offsetY","pageX","pageY","y1","panelRelY","posX1","posX2","selectionX","selectionWidth","position","graphTooltip","annotations","annoData","time","source","anno","iconColor","join","$ticks","mouseOverAnnotationTick","secPerTick","oneDay","oneYear","tickStep","getScaledDecimals","getFlotTickSize","DEFAULT_Y_TICK_SIZE_PX"],"mappings":";;;;;;;AAsBe,WAASA,IAAT,CAAcC,KAAd,EAAqBC,IAArB,EAA2BC,KAA3B,EAAkCC,IAAlC,EAAwC;AACrD,QAAIC,IAAJ,EAAUC,SAAV,EAAqBC,SAArB,EAAgCC,KAAhC,EAAuCC,OAAvC,CADqD,CAGrD;;AACA,QAAIC,QAAQ,GAAGR,IAAI,CAACS,IAAL,CAAU,uBAAV,CAAf;AACA,QAAIC,OAAO,GAAG,IAAIC,oBAAJ,CAAyBH,QAAzB,EAAmCT,KAAnC,CAAd;AACA,QAAIa,iBAAiB,GAAG,IAAIC,iBAAJ,CAAsBL,QAAtB,EAAgCT,KAAhC,CAAxB;AAEA,QAAIe,KAAJ,EAAWC,MAAX,EACIC,MADJ,EACYC,MADZ,EAEIC,UAFJ,EAEgBC,WAFhB,EAGIC,QAHJ,EAGcC,WAHd,EAIIC,UAJJ,EAIgBC,WAJhB,EAKIC,YALJ,EAKkBC,YALlB,EAKgCC,SALhC,EAMIC,SANJ,EAMeC,UANf,EAOIC,UAPJ,EAOgBC,YAPhB,EAQIC,cARJ,EASIC,SATJ,EASeC,SATf;AAWA,QAAIC,OAAO,GAAG,CAAd;AAEA,QAAIC,SAAS,GAAG;AACdC,MAAAA,MAAM,EAAE,KADM;AAEdC,MAAAA,EAAE,EAAE,CAAC,CAFS;AAGdC,MAAAA,EAAE,EAAE,CAAC;AAHS,KAAhB;AAMA,QAAIC,OAAO,GAAG;AAACC,MAAAA,IAAI,EAAE,CAAP;AAAUC,MAAAA,KAAK,EAAE,CAAjB;AAAoBC,MAAAA,GAAG,EAAE,CAAzB;AAA4BC,MAAAA,MAAM,EAAE;AAApC,KAAd;AAAA,QACIC,MAAM,GAAG;AAACJ,MAAAA,IAAI,EAAE,EAAP;AAAWC,MAAAA,KAAK,EAAE,EAAlB;AAAsBC,MAAAA,GAAG,EAAE,EAA3B;AAA+BC,MAAAA,MAAM,EAAE;AAAvC,KADb;AAAA,QAEIE,qBAAqB,GAAGC,wBAF5B;AAIA5C,IAAAA,IAAI,CAAC6C,MAAL,CAAYC,EAAZ,CAAe,QAAf,EAAyB,YAAM;AAC7BC,MAAAA,MAAM;AACP,KAFD;;AAIA,aAASC,gBAAT,GAA4B;AAC1B,UAAI;AACF,YAAInC,MAAM,GAAGb,IAAI,CAACa,MAAL,IAAeT,KAAK,CAACS,MAArB,IAA+Bb,IAAI,CAACiD,GAAL,CAASpC,MAArD;;AACA,YAAIqC,CAAC,CAACC,QAAF,CAAWtC,MAAX,CAAJ,EAAwB;AACtBA,UAAAA,MAAM,GAAGuC,QAAQ,CAACvC,MAAM,CAACwC,OAAP,CAAe,IAAf,EAAqB,EAArB,CAAD,EAA2B,EAA3B,CAAjB;AACD;;AAEDxC,QAAAA,MAAM,IAAIT,KAAK,CAACkD,MAAN,CAAaC,IAAb,GAAoB,EAApB,GAAyB,EAAnC,CANE,CAMqC;;AAEvCjD,QAAAA,QAAQ,CAACkD,GAAT,CAAa,QAAb,EAAuB3C,MAAM,GAAG,IAAhC;AAEA,eAAO,IAAP;AACD,OAXD,CAWE,OAAO4C,CAAP,EAAU;AAAE;AACZ,eAAO,KAAP;AACD;AACF;;AAED,aAASC,aAAT,CAAuB5D,IAAvB,EAA6B;AAC3B,UAAI6D,SAAS,GAAG7D,IAAI,CAAC8D,SAAL,CAAe,cAAf,EAA+BC,KAA/B,EAAhB;;AACA,UAAIC,cAAc,GAAGZ,CAAC,CAACa,GAAF,CAAMb,CAAC,CAACc,GAAF,CAAML,SAAN,EAAiB,UAAAM,IAAI,EAAI;AAClD;AACA,eAAOA,IAAI,CAACC,OAAL,GAAetD,KAAtB;AACD,OAH0B,CAAN,CAArB;;AAKA,aAAOuD,IAAI,CAACC,IAAL,CAAUN,cAAV,CAAP;AACD;;AAED,aAASO,cAAT,CAAwBvE,IAAxB,EAA8B;AAC5B,UAAIwE,SAAS,GAAGxE,IAAI,CAACyE,MAAL,CAAY,cAAZ,CAAhB;;AACA,UAAI,CAACD,SAAS,CAACE,KAAV,EAAL,EAAwB;AACtB,YAAIC,kBAAkB,GAAGC,UAAU,CAAC5E,IAAI,CAACyE,MAAL,CAAY,cAAZ,EAA4BI,IAA5B,CAAiC,IAAjC,CAAD,CAAnC;AACA,YAAIC,YAAY,GAAGF,UAAU,CAAC5E,IAAI,CAAC6E,IAAL,CAAU,QAAV,CAAD,CAA7B;AACA,eAAOC,YAAY,GAAGH,kBAAtB;AACD,OAJD,MAIO;AACL;AACA,eAAO,EAAP;AACD;AACF;;AAED,aAASI,QAAT,GAAoB;AAClB;AACAhF,MAAAA,KAAK,CAACkB,MAAN,GAAeA,MAAM,GAAG+D,EAAE,CAACC,SAAH,GACrBC,MADqB,CACd,CAAC7E,SAAS,CAAC8E,IAAX,EAAiB9E,SAAS,CAAC+E,EAA3B,CADc,EAErBC,KAFqB,CAEf,CAACrD,SAAS,GAAC,CAAX,EAAcd,UAAU,GAACc,SAAS,GAAC,CAAnC,CAFe,CAAxB;AAIA,UAAIsD,KAAK,GAAGpE,UAAU,GAAGqE,sBAAzB;AACA,UAAIC,oBAAoB,GAAGC,iBAAiB,CAACH,KAAD,EAAQjF,SAAS,CAAC8E,IAAlB,EAAwB9E,SAAS,CAAC+E,EAAlC,CAA5C;AACA,UAAIM,UAAJ;AACA,UAAIC,iBAAiB,GAAGzF,IAAI,CAAC0F,SAAL,CAAeC,WAAf,EAAxB;;AACA,UAAIF,iBAAiB,KAAK,KAA1B,EAAiC;AAC/BD,QAAAA,UAAU,GAAGV,EAAE,CAACc,SAAH,CAAaN,oBAAb,CAAb;AACD,OAFD,MAEO;AACLE,QAAAA,UAAU,GAAGV,EAAE,CAACU,UAAH,CAAcF,oBAAd,CAAb;AACD;;AAED,UAAIO,KAAK,GAAGf,EAAE,CAACgB,UAAH,CAAc/E,MAAd,EACTqE,KADS,CACHA,KADG,EAETW,UAFS,CAEEP,UAFF,EAGTQ,WAHS,CAGGC,mBAHH,EAITC,QAJS,CAIAjF,WAJA,CAAZ;AAMA,UAAIkF,IAAI,GAAGjF,QAAX;AACA,UAAIkF,IAAI,GAAGhF,UAAX;AAEAf,MAAAA,OAAO,CAACgG,MAAR,CAAe,GAAf,EACG1B,IADH,CACQ,OADR,EACiB,aADjB,EAEGA,IAFH,CAEQ,WAFR,EAEqB,eAAeyB,IAAf,GAAsB,GAAtB,GAA4BD,IAA5B,GAAmC,GAFxD,EAGGG,IAHH,CAGQT,KAHR,EAzBkB,CA8BlB;;AACAxF,MAAAA,OAAO,CAACkE,MAAR,CAAe,SAAf,EAA0BA,MAA1B,CAAiC,SAAjC,EAA4CgC,MAA5C;AACD,KA1GoD,CA4GrD;;;AACA,aAASC,SAAT,CAAmBpB,KAAnB,EAA0B;AACxB,UAAID,KAAK,GAAG,EAAZ;AACA,UAAIsB,IAAI,GAAGxF,WAAW,GAAGmE,KAAK,CAACsB,MAA/B,CAFwB,CAGxB;;AACAvB,MAAAA,KAAK,CAACwB,IAAN,CAAWF,IAAX;;AACA,WAAK,IAAIG,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGxB,KAAK,CAACsB,MAA1B,EAAkCE,CAAC,EAAnC,EAAuC;AACrCzB,QAAAA,KAAK,CAACwB,IAAN,CAAWF,IAAI,IAAIG,CAAC,GAAC,CAAN,CAAf;AACD;;AACD,aAAO9B,EAAE,CAAC+B,YAAH,GACJ7B,MADI,CACGI,KADH,EAEJD,KAFI,CAEEA,KAFF,CAAP;AAGD,KAxHoD,CA0HrD;;;AACA,aAAS2B,aAAT,CAAuB1B,KAAvB,EAA8B;AAC5B,UAAID,KAAK,GAAG,EAAZ;AACA,UAAIsB,IAAI,GAAGxF,WAAW,GAAGmE,KAAK,CAACsB,MAA/B,CAF4B,CAG5B;;AACAvB,MAAAA,KAAK,CAACwB,IAAN,CAAW3E,OAAX;;AACA,WAAK,IAAI4E,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGxB,KAAK,CAACsB,MAA1B,EAAkCE,CAAC,EAAnC,EAAuC;AACrCzB,QAAAA,KAAK,CAACwB,IAAN,CAAWF,IAAI,GAAGG,CAAP,GAAW5E,OAAtB;AACD;;AACD,aAAO8C,EAAE,CAAC+B,YAAH,GACJ7B,MADI,CACGI,KADH,EAEJD,KAFI,CAEEA,KAFF,CAAP;AAGD;;AAED,aAAS4B,QAAT,GAAoB;AAClB,UAAI3B,KAAK,GAAGlC,CAAC,CAAC8D,IAAF,CAAO9D,CAAC,CAACc,GAAF,CAAM/D,IAAN,EAAY,UAAAgH,CAAC;AAAA,eAAIA,CAAC,CAACC,MAAN;AAAA,OAAb,CAAP,CAAZ,CADkB,CAGlB;;;AACA,UAAIhE,CAAC,CAACiE,OAAF,CAAUlH,IAAV,CAAJ,EAAqB;AACnBmF,QAAAA,KAAK,GAAG,CAAC,EAAD,CAAR;AACD;;AAED,UAAIhF,KAAK,CAACgH,SAAN,IAAmB,OAAvB,EAAgC;AAC9BhC,QAAAA,KAAK,CAACiC,IAAN,CAAW,UAACC,CAAD,EAAIC,CAAJ;AAAA,iBAAUD,CAAC,CAACE,aAAF,CAAgBD,CAAhB,EAAmB,IAAnB,EAAyB;AAACE,YAAAA,iBAAiB,EAAE,KAApB;AAA2BC,YAAAA,OAAO,EAAE;AAApC,WAAzB,CAAV;AAAA,SAAX;AACD,OAFD,MAEO,IAAItH,KAAK,CAACgH,SAAN,IAAmB,OAAvB,EAAgC;AACrChC,QAAAA,KAAK,CAACiC,IAAN,CAAW,UAACE,CAAD,EAAID,CAAJ;AAAA,iBAAUA,CAAC,CAACE,aAAF,CAAgBD,CAAhB,EAAmB,IAAnB,EAAyB;AAACE,YAAAA,iBAAiB,EAAE,KAApB;AAA2BC,YAAAA,OAAO,EAAE;AAApC,WAAzB,CAAV;AAAA,SAAX;AACD;;AAED,UAAIC,UAAU,GAAGb,aAAa,CAAC1B,KAAD,CAA9B;AACAvF,MAAAA,KAAK,CAACiB,MAAN,GAAeA,MAAM,GAAG0F,SAAS,CAACpB,KAAD,CAAjC;AAEA,UAAIwC,KAAK,GAAG9C,EAAE,CAAC+C,QAAH,CAAYF,UAAZ,EACTG,UADS,CACE1C,KADF,EAET2C,aAFS,CAEK,IAAInH,KAFT,EAGToF,WAHS,CAGGgC,mBAHH,CAAZ;AAKA3H,MAAAA,OAAO,CAACgG,MAAR,CAAe,GAAf,EACG1B,IADH,CACQ,OADR,EACiB,aADjB,EAEG2B,IAFH,CAEQsB,KAFR,EAtBkB,CA0BlB;;AACA,UAAIzB,IAAI,GAAGzD,MAAM,CAACF,GAAlB;AACA,UAAI4D,IAAI,GAAG1C,aAAa,CAACrD,OAAD,CAAb,GAAyB2H,mBAApC;AACA3H,MAAAA,OAAO,CAACkE,MAAR,CAAe,SAAf,EAA0BI,IAA1B,CAA+B,WAA/B,EAA4C,eAAeyB,IAAf,GAAsB,GAAtB,GAA4BD,IAA5B,GAAmC,GAA/E,EA7BkB,CA+BlB;;AACA9F,MAAAA,OAAO,CAACkE,MAAR,CAAe,SAAf,EAA0BA,MAA1B,CAAiC,SAAjC,EAA4CgC,MAA5C;AACAlG,MAAAA,OAAO,CAACkE,MAAR,CAAe,SAAf,EAA0BX,SAA1B,CAAoC,YAApC,EAAkD2C,MAAlD;AACD,KA1KoD,CA4KrD;;;AACA,aAAS0B,cAAT,CAAwBC,GAAxB,EAA6BnE,GAA7B,EAAkCoE,YAAlC,EAAgD;AAC9C,UAAIC,QAAQ,GAAG,CAACrE,GAAG,IAAIpB,qBAAqB,GAAG,CAA5B,CAAH,GAAoCuF,GAAG,IAAIvF,qBAAqB,GAAG,CAA5B,CAAxC,IAA0E,CAAzF;AACA,UAAI0F,KAAJ,EAAWC,KAAX;;AAEA,UAAIH,YAAY,KAAK,CAArB,EAAwB;AACtBG,QAAAA,KAAK,GAAGvE,GAAG,GAAGpB,qBAAd;AACA0F,QAAAA,KAAK,GAAGH,GAAG,GAAGA,GAAG,IAAIvF,qBAAqB,GAAG,CAA5B,CAAjB;AACAwF,QAAAA,YAAY,GAAG,CAACG,KAAK,GAAGD,KAAT,IAAkB,CAAjC;AACD,OAJD,MAIO;AACLC,QAAAA,KAAK,GAAGnE,IAAI,CAACC,IAAL,CAAU,CAACL,GAAG,GAAGqE,QAAP,IAAmBD,YAA7B,IAA6CA,YAArD;AACAE,QAAAA,KAAK,GAAGlE,IAAI,CAACoE,KAAL,CAAW,CAACL,GAAG,GAAGE,QAAP,IAAmBD,YAA9B,IAA8CA,YAAtD;AACD,OAX6C,CAa9C;;;AACA,UAAID,GAAG,IAAI,CAAP,IAAYG,KAAK,GAAG,CAAxB,EAA2B;AACzBA,QAAAA,KAAK,GAAG,CAAR;AACD;;AAED,aAAO;AAACA,QAAAA,KAAK,EAALA,KAAD;AAAQC,QAAAA,KAAK,EAALA;AAAR,OAAP;AACD;;AAED,aAASE,kBAAT,CAA4BC,QAA5B,EAA6D;AAAA,UAAvBC,cAAuB,uEAAN,IAAM;AAC3D,UAAIC,MAAM,GAAGvI,KAAK,CAACwH,KAAN,CAAYe,MAAzB;AACA,aAAO,UAASC,KAAT,EAAgB;AACrB,eAAOC,GAAG,CAACC,YAAJ,CAAiBH,MAAjB,EAAyBC,KAAzB,EAAgCH,QAAhC,EAA0CC,cAA1C,CAAP;AACD,OAFD;AAGD,KAvMoD,CAyMrD;AACA;;;AACA,aAASK,gBAAT,GAA4B;AAC1B,UAAIC,YAAY,GAAG1I,QAAQ,CAAC,CAAD,CAA3B;AAEAM,MAAAA,KAAK,GAAGuD,IAAI,CAACoE,KAAL,CAAWjI,QAAQ,CAACM,KAAT,EAAX,IAA+ByB,OAAO,CAACE,KAA/C;AACA1B,MAAAA,MAAM,GAAGsD,IAAI,CAACoE,KAAL,CAAWjI,QAAQ,CAACO,MAAT,EAAX,IAAgCwB,OAAO,CAACI,MAAjD;;AAEA,UAAIpC,OAAJ,EAAa;AACXA,QAAAA,OAAO,CAACkG,MAAR;AACD;;AAEDlG,MAAAA,OAAO,GAAGyE,EAAE,CAACP,MAAH,CAAUyE,YAAV,EACP3C,MADO,CACA,KADA,EAEP1B,IAFO,CAEF,OAFE,EAEO/D,KAFP,EAGP+D,IAHO,CAGF,QAHE,EAGQ9D,MAHR,CAAV;AAKAI,MAAAA,WAAW,GAAGJ,MAAM,GAAG6B,MAAM,CAACF,GAAhB,GAAsBE,MAAM,CAACD,MAA3C;AACAvB,MAAAA,QAAQ,GAAGwB,MAAM,CAACF,GAAlB;AACArB,MAAAA,WAAW,GAAGD,QAAQ,GAAGD,WAAzB;AAEAM,MAAAA,YAAY,GAAGnB,KAAK,CAAC6I,KAAN,CAAY1H,YAAZ,KAA6B,IAA7B,GAAoCnB,KAAK,CAAC6I,KAAN,CAAY1H,YAAhD,GAA+D2H,cAA9E;AACA5H,MAAAA,YAAY,GAAGlB,KAAK,CAAC6I,KAAN,CAAY3H,YAAZ,KAA6B,IAA7B,GAAoClB,KAAK,CAAC6I,KAAN,CAAY3H,YAAhD,GAA+D6H,cAA9E;AACA3H,MAAAA,SAAS,GAAGpB,KAAK,CAAC6I,KAAN,CAAYzH,SAAZ,KAA0B,IAA1B,GAAiCpB,KAAK,CAAC6I,KAAN,CAAYzH,SAA7C,GAAyD4H,UAArE,CArB0B,CAuB1B;;AACArH,MAAAA,SAAS,GAAGoC,IAAI,CAACoE,KAAL,CAAWtH,WAAW,GAAGf,SAAS,CAACmJ,WAAnC,CAAZ;AACA3H,MAAAA,UAAU,GAAGK,SAAS,GAAGA,SAAS,GAAGT,YAAf,GAA8B,CAApD;AACAU,MAAAA,OAAO,GAAGN,UAAU,GAAG,CAAvB;AAEAqF,MAAAA,QAAQ;AAER3F,MAAAA,UAAU,GAAGsC,aAAa,CAACrD,OAAD,CAAb,GAAyB2H,mBAAtC;AACAhH,MAAAA,UAAU,GAAGJ,KAAK,GAAGQ,UAAR,GAAqBsB,MAAM,CAACH,KAAzC,CA/B0B,CAiC1B;AACA;;AACAT,MAAAA,SAAS,GAAGd,UAAU,IAAId,SAAS,CAACoJ,WAAV,GAAsB,CAA1B,CAAtB;AACA7H,MAAAA,SAAS,GAAGK,SAAS,GAAGP,YAAxB;AAEAsD,MAAAA,QAAQ;AACRxD,MAAAA,WAAW,GAAGgD,cAAc,CAAChE,OAAD,CAA5B;;AAEA,UAAI,CAACD,KAAK,CAACwH,KAAN,CAAYrE,IAAjB,EAAuB;AACrBlD,QAAAA,OAAO,CAACkE,MAAR,CAAe,SAAf,EAA0BX,SAA1B,CAAoC,MAApC,EAA4C2F,KAA5C,CAAkD,SAAlD,EAA6D,CAA7D;AACD;;AAED,UAAI,CAACnJ,KAAK,CAACyF,KAAN,CAAYtC,IAAjB,EAAuB;AACrBlD,QAAAA,OAAO,CAACkE,MAAR,CAAe,SAAf,EAA0BX,SAA1B,CAAoC,MAApC,EAA4C2F,KAA5C,CAAkD,SAAlD,EAA6D,CAA7D;AACD;AACF;;AAED,aAASC,UAAT,GAAsB;AACpBT,MAAAA,gBAAgB;AAEhB,UAAIU,QAAQ,GAAGrJ,KAAK,CAACsJ,KAAN,CAAY3F,GAAZ,IAAmB7D,SAAS,CAACuJ,QAA5C;AACA,UAAIE,QAAQ,GAAGvJ,KAAK,CAACsJ,KAAN,CAAYxB,GAAZ,IAAmBhI,SAAS,CAACyJ,QAA5C;;AAEA,UAAIvJ,KAAK,CAACsJ,KAAN,CAAYE,IAAZ,KAAqB,UAAzB,EAAqC;AACnCjI,QAAAA,UAAU,GAAGkI,aAAa,CAACJ,QAAD,EAAWE,QAAX,CAA1B;AACD;;AACDG,MAAAA,eAAe,CAACL,QAAD,CAAf;AAEA,UAAIR,KAAK,GAAG5I,OAAO,CAACuD,SAAR,CAAkB,sBAAlB,EAA0C3D,IAA1C,CAA+CC,SAAS,CAAC+I,KAAzD,CAAZ;AACAA,MAAAA,KAAK,CAAC5C,MAAN,CAAa,OAAb;AACA4C,MAAAA,KAAK,GAAGA,KAAK,CAACc,KAAN,GAAc1D,MAAd,CAAqB,MAArB,EACP1B,IADO,CACF,QADE,EACQ,UAAAqF,CAAC;AAAA,eAAIA,CAAC,CAACC,EAAN;AAAA,OADT,EAEPtF,IAFO,CAEF,GAFE,EAEGuF,QAFH,EAGPvF,IAHO,CAGF,OAHE,EAGOwF,YAHP,EAIPxF,IAJO,CAIF,GAJE,EAIGyF,QAJH,EAKPzF,IALO,CAKF,QALE,EAKQ0F,aALR,EAMP1F,IANO,CAMF,IANE,EAMInD,SANJ,EAOPmD,IAPO,CAOF,IAPE,EAOInD,SAPJ,EAQPmD,IARO,CAQF,OARE,EAQO,8BARP,EASP4E,KATO,CASD,MATC,EASOe,YATP,EAUPf,KAVO,CAUD,QAVC,EAUSe,YAVT,EAWPf,KAXO,CAWD,cAXC,EAWe,CAXf,EAYR;AACA;AAbQ,OAcPA,KAdO,CAcD,SAdC,EAcUgB,cAdV,CAAR;AAgBA,UAAIC,MAAM,GAAGlK,QAAQ,CAACC,IAAT,CAAc,sBAAd,CAAb;AACAiK,MAAAA,MAAM,CAAC1H,EAAP,CAAU,YAAV,EAAwB,UAAC2H,KAAD,EAAW;AACjCjK,QAAAA,OAAO,CAACkK,eAAR,GAA0B,IAA1B;AACAC,QAAAA,aAAa,CAACF,KAAD,CAAb;AACD,OAHD,EAIC3H,EAJD,CAII,YAJJ,EAIkB,UAAC2H,KAAD,EAAW;AAC3BjK,QAAAA,OAAO,CAACkK,eAAR,GAA0B,KAA1B;AACAE,QAAAA,kBAAkB,CAACH,KAAD,CAAlB;AACD,OAPD;;AASAI,MAAAA,kBAAkB;;AAElB7K,MAAAA,IAAI,CAAC6C,MAAL,CAAYiI,IAAZ,CAAiB,iBAAjB,EAAoC;AAClC,sBAAc9J;AADoB,OAApC;AAGD;;AAED,aAAS2J,aAAT,CAAuBF,KAAvB,EAA8B;AAC5B,UAAIf,KAAK,GAAG5E,EAAE,CAACP,MAAH,CAAUkG,KAAK,CAACvD,MAAhB,EAAwBqC,KAAxB,CAA8B,MAA9B,CAAZ;AACA,UAAIwB,cAAc,GAAGjG,EAAE,CAAC4E,KAAH,CAASA,KAAT,EAAgBsB,MAAhB,CAAuB,CAAvB,CAArB;AACA,UAAIC,WAAW,GAAGnG,EAAE,CAAC4E,KAAH,CAASA,KAAT,EAAgBwB,QAAhB,CAAyB,CAAzB,CAAlB;AACA,UAAIC,YAAY,GAAGrG,EAAE,CAACP,MAAH,CAAUkG,KAAK,CAACvD,MAAhB,CAAnB;AACA1G,MAAAA,OAAO,CAAC4K,iBAAR,GAA4B1B,KAA5B;AACAyB,MAAAA,YAAY,CAAC5B,KAAb,CAAmB,MAAnB,EAA2BwB,cAA3B,EACCxB,KADD,CACO,QADP,EACiB0B,WADjB,EAEC1B,KAFD,CAEO,cAFP,EAEuB,CAFvB;AAGD;;AAED,aAASqB,kBAAT,CAA4BH,KAA5B,EAAmC;AACjC3F,MAAAA,EAAE,CACCP,MADH,CACUkG,KAAK,CAACvD,MADhB,EAEGqC,KAFH,CAES,MAFT,EAEiB/I,OAAO,CAAC4K,iBAFzB,EAGG7B,KAHH,CAGS,QAHT,EAGmB/I,OAAO,CAAC4K,iBAH3B,EAIG7B,KAJH,CAIS,cAJT,EAIyB,CAJzB;AAKD;;AAED,aAASM,aAAT,CAAuBJ,QAAvB,EAA+C;AAAA,UAAdE,QAAc,uEAAH,CAAG;;AAC7C,UAAI0B,WAAW,GAAGnI,CAAC,CAAC3C,IAAF,CAAOP,IAAI,CAACsL,YAAZ,EAA0B;AAAC1C,QAAAA,KAAK,EAAExI,KAAK,CAACsJ,KAAN,CAAY2B;AAApB,OAA1B,CAAlB;;AACA,UAAIE,iBAAiB,GAAGC,gBAAgB,CAACH,WAAW,CAACzC,KAAb,CAAxC;AACA,UAAI6C,kBAAkB,GAAGJ,WAAW,CAACK,MAAZ,KAAuB,QAAvB,IACtBL,WAAW,CAACK,MAAZ,KAAuB,MAAvB,IAAiC,CAACC,UAAU,CAACC,IAAX,CAAgBC,UADrD;AAGA,UAAIpC,QAAQ,IAAIE,QAAhB,EACEF,QAAQ,GAAGE,QAAQ,GAAG,CAAtB;AAEF,UAAImC,KAAK,GAAGL,kBAAkB,GAAGhC,QAAH,GAAcE,QAA5C;AACA,UAAIoC,GAAG,GAAGN,kBAAkB,GAAG9B,QAAH,GAAcF,QAA1C;AAEA,aAAO3E,EAAE,CAACkH,eAAH,CAAmBT,iBAAnB,EAAsCvG,MAAtC,CAA6C,CAAC8G,KAAD,EAAQC,GAAR,CAA7C,CAAP;AACD;;AAED,aAASjC,eAAT,CAAyBL,QAAzB,EAAmC;AACjC,UAAIrJ,KAAK,CAACsJ,KAAN,CAAY/H,UAAZ,KAA2B,QAA/B,EAAyC;AACvCC,QAAAA,YAAY,GAAGkD,EAAE,CAACmH,WAAH,GACdjH,MADc,CACP,CAAC,CAAD,EAAIyE,QAAJ,CADO,EAEdtE,KAFc,CAER,CAAC,CAAD,EAAI,CAAJ,CAFQ,CAAf;AAGD,OAJD,MAIO,IAAI/E,KAAK,CAACsJ,KAAN,CAAY/H,UAAZ,KAA2B,MAA/B,EAAuC;AAC5CC,QAAAA,YAAY,GAAGkD,EAAE,CAACoH,QAAH,GAAcC,QAAd,CAAuB/L,KAAK,CAACsJ,KAAN,CAAYyC,QAAnC,EACdnH,MADc,CACP,CAAC,CAAD,EAAIyE,QAAJ,CADO,EAEdtE,KAFc,CAER,CAAC,CAAD,EAAI,CAAJ,CAFQ,CAAf;AAGD;AACF;;AAED,aAAS+E,QAAT,CAAkBjD,CAAlB,EAAqB;AACnB,UAAImF,CAAJ,CADmB,CAEnB;;AACA,UAAIC,EAAE,GAAGtL,MAAM,CAACkG,CAAC,CAACmF,CAAH,CAAf;;AAEA,UAAIC,EAAE,GAAG5K,SAAS,GAAC,CAAf,GAAmB,CAAvB,EAA0B;AACxB2K,QAAAA,CAAC,GAAGhL,UAAU,GAAGG,YAAY,GAAC,CAA9B;AACD,OAFD,MAEO;AACL6K,QAAAA,CAAC,GAAGhL,UAAU,GAAGiL,EAAb,GAAkB5K,SAAS,GAAC,CAAhC;AACD;;AAED,aAAO2K,CAAP;AACD,KArWoD,CAuWrD;;;AACA,aAASjC,YAAT,CAAsBlD,CAAtB,EAAyB;AACvB,UAAIqF,CAAJ;AACA,UAAID,EAAE,GAAGtL,MAAM,CAACkG,CAAC,CAACmF,CAAH,CAAf;;AAEA,UAAIC,EAAE,GAAG5K,SAAS,GAAC,CAAnB,EAAsB;AACpB;AACA;AACA,YAAI8K,YAAY,GAAIF,EAAE,GAAG9K,YAAY,GAAC,CAAnB,GAAwBE,SAAS,GAAC,CAArD;AACA6K,QAAAA,CAAC,GAAGC,YAAY,GAAG,CAAf,GAAmBA,YAAnB,GAAkC,CAAtC;AACD,OALD,MAKO,IAAIvL,UAAU,GAAGqL,EAAb,GAAkB5K,SAAS,GAAC,CAAhC,EAAmC;AACxC;AACA6K,QAAAA,CAAC,GAAG7K,SAAS,GAAC,CAAV,IAAeT,UAAU,GAAGqL,EAAb,GAAkB9K,YAAY,GAAC,CAA9C,CAAJ;AACD,OAHM,MAGA;AACL+K,QAAAA,CAAC,GAAG7K,SAAJ;AACD,OAdsB,CAgBvB;;;AACA6K,MAAAA,CAAC,GAAGnI,IAAI,CAACJ,GAAL,CAASuI,CAAT,EAAYE,aAAZ,CAAJ;;AAEA,UAAIjL,YAAY,IAAI,CAApB,EAAuB;AACrB+K,QAAAA,CAAC,GAAGA,CAAC,GAAC,CAAN;AACD;;AAED,aAAOA,CAAP;AACD;;AAED,aAASlC,QAAT,CAAkBnD,CAAlB,EAAqB;AACnB,aAAOnG,MAAM,CAACmG,CAAC,CAACwF,CAAH,CAAN,GAAcvL,QAAd,GAAyBQ,UAAzB,GAAsCJ,YAAY,GAAC,CAA1D;AACD;;AAED,aAAS+I,aAAT,CAAuBpD,CAAvB,EAA0B;AACxB,UAAIyF,EAAE,GAAG5L,MAAM,CAACmG,CAAC,CAACwF,CAAH,CAAf;AACA,UAAIA,CAAC,GAAGC,EAAE,GAAGxL,QAAL,GAAgBQ,UAAhB,GAA6BJ,YAAY,GAAC,CAAlD;AACA,UAAIqL,CAAC,GAAGjL,UAAR,CAHwB,CAKxB;;AACA,UAAI+K,CAAC,GAAGvL,QAAR,EAAkB;AAChByL,QAAAA,CAAC,GAAGD,EAAE,GAAGpL,YAAY,GAAC,CAAtB;AACD,OAFD,MAEO,IAAIoL,EAAE,GAAGvL,WAAT,EAAsB;AAC3BwL,QAAAA,CAAC,GAAGxL,WAAW,GAAGsL,CAAlB;AACD,OAFM,MAEA,IAAIA,CAAC,GAAG/K,UAAJ,GAAiBP,WAArB,EAAkC;AACvCwL,QAAAA,CAAC,GAAGxL,WAAW,GAAGsL,CAAlB;AACD,OAZuB,CAcxB;;;AACAE,MAAAA,CAAC,GAAGxI,IAAI,CAAC+D,GAAL,CAASyE,CAAT,EAAY1L,WAAZ,CAAJ,CAfwB,CAgBxB;;AACA0L,MAAAA,CAAC,GAAGxI,IAAI,CAACJ,GAAL,CAAS4I,CAAT,EAAYH,aAAZ,CAAJ;;AAEA,UAAIlL,YAAY,IAAI,CAApB,EAAuB;AACrBqL,QAAAA,CAAC,GAAGA,CAAC,GAAC,CAAN;AACD;;AAED,aAAOA,CAAP;AACD;;AAED,aAASrC,YAAT,CAAsBrD,CAAtB,EAAyB;AACvB,UAAI7G,KAAK,CAACsJ,KAAN,CAAYE,IAAZ,KAAqB,SAAzB,EAAoC;AAClC,eAAOxJ,KAAK,CAACsJ,KAAN,CAAYkD,SAAnB;AACD,OAFD,MAEO,IAAIxM,KAAK,CAACsJ,KAAN,CAAYE,IAAZ,KAAqB,UAAzB,EAAqC;AAC1C,eAAOjI,UAAU,CAACsF,CAAC,CAAC2B,KAAH,CAAjB;AACD,OAFM,MAEA,IAAIxI,KAAK,CAACsJ,KAAN,CAAYE,IAAZ,KAAqB,UAAzB,EAAqC;AAC1C,eAAO5J,IAAI,CAAC6M,cAAL,CAAoBC,cAApB,CAAmC7F,CAAC,CAAC8F,MAArC,CAAP;AACD;AACF;;AAED,aAASxC,cAAT,CAAwBtD,CAAxB,EAA2B;AACzB,UAAI7G,KAAK,CAAC4M,aAAN,KAAwB,UAAxB,IAAsC/F,CAAC,CAAC2B,KAAF,IAAW,IAArD,EAA4D;AAC1D,eAAO,CAAP;AACD;;AACD,UAAIxI,KAAK,CAACsJ,KAAN,CAAYE,IAAZ,KAAqB,SAAzB,EAAoC;AAClC,eAAOhI,YAAY,CAACqF,CAAC,CAAC2B,KAAH,CAAnB;AACD,OAFD,MAEO;AACL,eAAO,CAAP;AACD;AACF;;AAED,aAASqE,kBAAT,CAA4BhG,CAA5B,EAA+B;AAC7B,UAAI7G,KAAK,CAACsJ,KAAN,CAAYE,IAAZ,KAAqB,UAAzB,EAAqC;AACnC,eAAO,GAAP;AACD;;AACD,aAAO,GAAP;AACD,KA1boD,CA4brD;AACA;AACA;AAEA;;;AACAsD,IAAAA,SAAS,CAACpK,EAAV,CAAa,aAAb,EAA4B,UAAA2H,KAAK,EAAI;AACnC0C,MAAAA,mBAAmB,CAAC1C,KAAK,CAAC2C,GAAP,CAAnB;AACD,KAFD,EAEGvN,KAFH;AAIAqN,IAAAA,SAAS,CAACpK,EAAV,CAAa,mBAAb,EAAkC,YAAM;AACtCuK,MAAAA,cAAc;AACf,KAFD,EAEGxN,KAFH;;AAIA,aAASyN,WAAT,CAAqB7C,KAArB,EAA4B;AAC1BxI,MAAAA,SAAS,CAACC,MAAV,GAAmB,IAAnB;AACAD,MAAAA,SAAS,CAACE,EAAV,GAAesI,KAAK,CAAC8C,OAArB;;AAEA1L,MAAAA,cAAc,GAAG,0BAAW;AAC1B2L,QAAAA,SAAS;AACV,OAFD;;AAIAC,MAAAA,CAAC,CAACC,QAAD,CAAD,CAAYC,GAAZ,CAAgB,SAAhB,EAA2B9L,cAA3B;AACD;;AAED,aAAS2L,SAAT,GAAqB;AACnBC,MAAAA,CAAC,CAACC,QAAD,CAAD,CAAYE,MAAZ,CAAmB,SAAnB,EAA8B/L,cAA9B;AACAA,MAAAA,cAAc,GAAG,IAAjB;AACAI,MAAAA,SAAS,CAACC,MAAV,GAAmB,KAAnB;AAEA,UAAI2L,cAAc,GAAG1J,IAAI,CAAC2J,GAAL,CAAS7L,SAAS,CAACG,EAAV,GAAeH,SAAS,CAACE,EAAlC,CAArB;;AACA,UAAIF,SAAS,CAACG,EAAV,IAAgB,CAAhB,IAAqByL,cAAc,GAAGE,mBAA1C,EAA+D;AAC7D,YAAIC,QAAQ,GAAGjN,MAAM,CAAC2K,MAAP,CAAcvH,IAAI,CAAC+D,GAAL,CAASjG,SAAS,CAACE,EAAnB,EAAuBF,SAAS,CAACG,EAAjC,IAAuChB,UAAvC,GAAoDU,SAAS,GAAC,CAA5E,CAAf;AACA,YAAImM,MAAM,GAAGlN,MAAM,CAAC2K,MAAP,CAAcvH,IAAI,CAACJ,GAAL,CAAS9B,SAAS,CAACE,EAAnB,EAAuBF,SAAS,CAACG,EAAjC,IAAuChB,UAAvC,GAAoDU,SAAS,GAAC,CAA5E,CAAb;AAEA9B,QAAAA,IAAI,CAACkO,OAAL,CAAaC,OAAb,CAAqB;AACnBlJ,UAAAA,IAAI,EAAEmJ,MAAM,CAACC,GAAP,CAAWL,QAAX,CADa;AAEnB9I,UAAAA,EAAE,EAAEkJ,MAAM,CAACC,GAAP,CAAWJ,MAAX;AAFe,SAArB;AAID;;AAEDK,MAAAA,cAAc;AACf;;AAED,aAASC,YAAT,GAAwB;AACtBrB,MAAAA,SAAS,CAACpC,IAAV,CAAe,mBAAf;AACAuC,MAAAA,cAAc,GAFQ,CAGtB;AACD;;AAED,aAASmB,WAAT,CAAqB/D,KAArB,EAA4B;AAC1B,UAAI,CAACpK,OAAL,EAAc;AAAE;AAAS;;AAEzB,UAAI4B,SAAS,CAACC,MAAd,EAAsB;AACpB;AACAmL,QAAAA,cAAc;AACd7M,QAAAA,OAAO,CAACiO,OAAR;AACA/N,QAAAA,iBAAiB,CAAC+N,OAAlB;AAEAxM,QAAAA,SAAS,CAACG,EAAV,GAAesM,cAAc,CAACjE,KAAK,CAAC8C,OAAP,CAA7B;AACAoB,QAAAA,aAAa,CAAC1M,SAAS,CAACE,EAAX,EAAeF,SAAS,CAACG,EAAzB,CAAb;AACD,OARD,MAQO;AACLwM,QAAAA,kBAAkB,CAACnE,KAAD,CAAlB;AACAoE,QAAAA,aAAa,CAACpE,KAAK,CAAC8C,OAAP,CAAb;AACA/M,QAAAA,OAAO,CAAC+C,IAAR,CAAakH,KAAb,EAHK,CAGgB;;AACrB/J,QAAAA,iBAAiB,CAAC6C,IAAlB,CAAuBkH,KAAvB;AACD;AACF;;AAED,aAASmE,kBAAT,CAA4BnE,KAA5B,EAAmC;AACjC,UAAI2B,CAAC,GAAGrL,MAAM,CAAC2K,MAAP,CAAcjB,KAAK,CAAC8C,OAAN,GAAgBnM,UAAhB,GAA6BU,SAAS,GAAC,CAArD,EAAwDgN,OAAxD,EAAR;AACA,UAAIrC,CAAC,GAAG3L,MAAM,CAAC2J,KAAK,CAACsE,OAAP,CAAd;AACA,UAAI3B,GAAG,GAAG;AACR4B,QAAAA,KAAK,EAAEvE,KAAK,CAACuE,KADL;AAERC,QAAAA,KAAK,EAAExE,KAAK,CAACwE,KAFL;AAGR7C,QAAAA,CAAC,EAAEA,CAHK;AAGFjK,QAAAA,EAAE,EAAEiK,CAHF;AAIRK,QAAAA,CAAC,EAAEA,CAJK;AAIFyC,QAAAA,EAAE,EAAEzC,CAJF;AAKR0C,QAAAA,SAAS,EAAE;AALH,OAAV,CAHiC,CAWjC;;AACA/B,MAAAA,GAAG,CAAC+B,SAAJ,GAAgBhL,IAAI,CAACJ,GAAL,CAAS0G,KAAK,CAACsE,OAAN,GAAgBlO,MAAzB,EAAiC,KAAjC,CAAhB,CAZiC,CAcjC;;AACAqM,MAAAA,SAAS,CAACpC,IAAV,CAAe,aAAf,EAA8B;AAACsC,QAAAA,GAAG,EAAEA,GAAN;AAAWhN,QAAAA,KAAK,EAAEA;AAAlB,OAA9B;AACD;;AAED,aAASsO,cAAT,CAAwBtM,EAAxB,EAA4B;AAC1BA,MAAAA,EAAE,GAAG+B,IAAI,CAACJ,GAAL,CAAS3B,EAAT,EAAahB,UAAb,CAAL;AACAgB,MAAAA,EAAE,GAAG+B,IAAI,CAAC+D,GAAL,CAAS9F,EAAT,EAAapB,UAAU,GAAGI,UAA1B,CAAL;AACA,aAAOgB,EAAP;AACD;;AAED,aAASuM,aAAT,CAAuBS,KAAvB,EAA8BC,KAA9B,EAAqC;AACnC,UAAIhP,OAAJ,EAAa;AACXA,QAAAA,OAAO,CAACuD,SAAR,CAAkB,2BAAlB,EAA+C2C,MAA/C;AACA,YAAI+I,UAAU,GAAGnL,IAAI,CAAC+D,GAAL,CAASkH,KAAT,EAAgBC,KAAhB,CAAjB;AACA,YAAIE,cAAc,GAAGpL,IAAI,CAAC2J,GAAL,CAASsB,KAAK,GAAGC,KAAjB,CAArB;;AAEA,YAAIE,cAAc,GAAGxB,mBAArB,EAA0C;AACxC1N,UAAAA,OAAO,CAACgG,MAAR,CAAe,MAAf,EACC1B,IADD,CACM,OADN,EACe,0BADf,EAECA,IAFD,CAEM,GAFN,EAEW2K,UAFX,EAGC3K,IAHD,CAGM,OAHN,EAGe4K,cAHf,EAIC5K,IAJD,CAIM,GAJN,EAIWzD,QAJX,EAKCyD,IALD,CAKM,QALN,EAKgB1D,WALhB;AAMD;AACF;AACF;;AAED,aAASqN,cAAT,GAA0B;AACxBrM,MAAAA,SAAS,CAACE,EAAV,GAAe,CAAC,CAAhB;AACAF,MAAAA,SAAS,CAACG,EAAV,GAAe,CAAC,CAAhB;;AAEA,UAAI/B,OAAJ,EAAa;AACXA,QAAAA,OAAO,CAACuD,SAAR,CAAkB,2BAAlB,EAA+C2C,MAA/C;AACD;AACF;;AAED,aAASsI,aAAT,CAAuBW,QAAvB,EAAiC;AAC/B,UAAInP,OAAJ,EAAa;AACXA,QAAAA,OAAO,CAACuD,SAAR,CAAkB,2BAAlB,EAA+C2C,MAA/C;AAEA,YAAIH,IAAI,GAAGoJ,QAAX;AACApJ,QAAAA,IAAI,GAAGjC,IAAI,CAACJ,GAAL,CAASqC,IAAT,EAAehF,UAAf,CAAP;AACAgF,QAAAA,IAAI,GAAGjC,IAAI,CAAC+D,GAAL,CAAS9B,IAAT,EAAepF,UAAU,GAAGI,UAA5B,CAAP;AAEAf,QAAAA,OAAO,CAACgG,MAAR,CAAe,GAAf,EACC1B,IADD,CACM,OADN,EACe,0BADf,EAECA,IAFD,CAEM,WAFN,EAEmB,eAAeyB,IAAf,GAAsB,KAFzC,EAGCC,MAHD,CAGQ,MAHR,EAIC1B,IAJD,CAIM,IAJN,EAIY,CAJZ,EAKCA,IALD,CAKM,IALN,EAKYzD,QALZ,EAMCyD,IAND,CAMM,IANN,EAMY,CANZ,EAOCA,IAPD,CAOM,IAPN,EAOYxD,WAPZ,EAQCwD,IARD,CAQM,cARN,EAQsB,CARtB;AASD;AACF,KApkBoD,CAskBrD;;;AACA,aAASwI,mBAAT,CAA6BC,GAA7B,EAAkC;AAChC,UAAI/M,OAAO,IAAIL,IAAI,CAAC0F,SAAL,CAAe+J,YAAf,KAAgC,CAA/C,EAAkD;AAChD,YAAIrJ,IAAI,GAAGrF,MAAM,CAACqM,GAAG,CAAChB,CAAL,CAAN,GAAgBhL,UAA3B;AACAyN,QAAAA,aAAa,CAACzI,IAAD,CAAb;AACD;AACF;;AAED,aAASiH,cAAT,GAA0B;AACxB,UAAIhN,OAAJ,EAAa;AACXA,QAAAA,OAAO,CAACuD,SAAR,CAAkB,2BAAlB,EAA+C2C,MAA/C;AACD;AACF;;AAED,aAASxD,MAAT,GAAkB;AAChB9C,MAAAA,IAAI,GAAGD,IAAI,CAACC,IAAZ;AACAG,MAAAA,KAAK,GAAGJ,IAAI,CAACI,KAAb;AACAD,MAAAA,SAAS,GAAGH,IAAI,CAACmF,KAAjB;AACAjF,MAAAA,SAAS,GAAGF,IAAI,CAACE,SAAjB;;AAEA,UAAI,CAACD,IAAD,IAAS,CAACC,SAAV,IAAuB,CAAC8C,gBAAgB,EAA5C,EAAgD;AAC9C;AACD,OARe,CAUhB;;;AACA,UAAIE,CAAC,CAACiE,OAAF,CAAUjH,SAAS,CAAC+I,KAApB,CAAJ,EAAgC;AAC9BF,QAAAA,gBAAgB;AAChB;AACD;;AAEDS,MAAAA,UAAU;AACV3J,MAAAA,KAAK,CAACuB,UAAN,GAAmBA,UAAnB;AACAvB,MAAAA,KAAK,CAACwB,WAAN,GAAoBA,WAApB;AACAxB,MAAAA,KAAK,CAACoB,WAAN,GAAoBA,WAApB;AACApB,MAAAA,KAAK,CAACmB,UAAN,GAAmBA,UAAnB;AACAnB,MAAAA,KAAK,CAACqB,QAAN,GAAiBA,QAAjB;AACD,KA1mBoD,CA4mBrD;;;AACAZ,IAAAA,QAAQ,CAACwC,EAAT,CAAY,WAAZ,EAAyBwK,WAAzB;AACAhN,IAAAA,QAAQ,CAACwC,EAAT,CAAY,WAAZ,EAAyB0L,WAAzB;AACAlO,IAAAA,QAAQ,CAACwC,EAAT,CAAY,YAAZ,EAA0ByL,YAA1B;;AAEA,aAAS1D,kBAAT,GAA8B;AAC5B,UAAI,CAAC7K,IAAI,CAAC0P,WAAN,IAAqB1P,IAAI,CAAC0P,WAAL,CAAiBhJ,MAAjB,IAA2B,CAApD,EAAuD;AACrD;AACD;;AAED,UAAI,CAACrG,OAAL,EAAc;AACZ;AACD;;AAED,UAAIsP,QAAQ,GAAGzM,CAAC,CAACc,GAAF,CAAMhE,IAAI,CAAC0P,WAAX,EAAwB,UAACzI,CAAD,EAAGL,CAAH;AAAA,eAAU;AAAC,eAAKzC,IAAI,CAACoE,KAAL,CAAWnH,UAAU,GAAGL,MAAM,CAACkG,CAAC,CAAC2I,IAAH,CAA9B,CAAN;AAA+C,gBAAKhJ,CAApD;AAAuD,kBAAQK,CAAC,CAAC4I;AAAjE,SAAV;AAAA,OAAxB,CAAf;;AAGA,UAAIC,IAAI,GAAGzP,OAAO,CACfgG,MADQ,CACD,GADC,EAER1B,IAFQ,CAEH,OAFG,EAEM,uBAFN,EAGRA,IAHQ,CAGH,WAHG,EAGU,kBAHV,EAIRf,SAJQ,CAIE,wBAJF,EAKR3D,IALQ,CAKH0P,QALG,EAMR5F,KANQ,GAMA1D,MANA,CAMO,GANP,CAAX;AAQAyJ,MAAAA,IAAI,CAACzJ,MAAL,CAAY,MAAZ,EACE;AADF,OAEG1B,IAFH,CAEQ,IAFR,EAEc,UAAAsC,CAAC;AAAA,eAAIA,CAAC,CAACmF,CAAN;AAAA,OAFf,EAGGzH,IAHH,CAGQ,IAHR,EAGczD,QAHd,EAIGyD,IAJH,CAIQ,IAJR,EAIc,UAAAsC,CAAC;AAAA,eAAIA,CAAC,CAACmF,CAAN;AAAA,OAJf,EAKGzH,IALH,CAKQ,IALR,EAKcxD,WALd,EAMGoI,KANH,CAMS,QANT,EAMmB,UAAAtC,CAAC;AAAA,eAAIA,CAAC,CAAC6I,IAAF,CAAOC,SAAX;AAAA,OANpB,EAOGxG,KAPH,CAOS,cAPT,EAOyB,CAPzB,EAQGA,KARH,CAQS,kBART,EAQ6B,KAR7B;AAUAuG,MAAAA,IAAI,CAACzJ,MAAL,CAAY,SAAZ,EACG1B,IADH,CACQ,QADR,EACkB,UAAAsC,CAAC;AAAA,eAAI,CAAC,CAACA,CAAC,CAACmF,CAAH,EAAMjL,WAAW,GAAC,CAAlB,CAAD,EAAuB,CAAC8F,CAAC,CAACmF,CAAF,GAAI,CAAL,EAAQjL,WAAW,GAAC,CAApB,CAAvB,EAA+C,CAAC8F,CAAC,CAACmF,CAAF,GAAI,CAAL,EAAQjL,WAAW,GAAC,CAApB,CAA/C,EAAuE6O,IAAvE,CAA4E,GAA5E,CAAJ;AAAA,OADnB,EAEGzG,KAFH,CAES,cAFT,EAEyB,CAFzB,EAGGA,KAHH,CAGS,MAHT,EAGiB,UAAAtC,CAAC;AAAA,eAAIA,CAAC,CAAC6I,IAAF,CAAOC,SAAX;AAAA,OAHlB,EA9B4B,CAmC5B;;AACAD,MAAAA,IAAI,CAACzJ,MAAL,CAAY,MAAZ,EACG1B,IADH,CACQ,GADR,EACa,UAAAsC,CAAC;AAAA,eAAIA,CAAC,CAACmF,CAAF,GAAI,CAAR;AAAA,OADd,EAEGzH,IAFH,CAEQ,OAFR,EAEiB,EAFjB,EAGGA,IAHH,CAGQ,GAHR,EAGaxD,WAAW,GAAC,CAHzB,EAIGwD,IAJH,CAIQ,QAJR,EAIkB,CAJlB,EAKGA,IALH,CAKQ,OALR,EAKiB,2BALjB,EAMGA,IANH,CAMQ,QANR,EAMkB,UAAAsC,CAAC;AAAA,eAAIA,CAAC,CAACgD,EAAN;AAAA,OANnB,EAOGV,KAPH,CAOS,SAPT,EAOoB,CAPpB;AAUA,UAAI0G,MAAM,GAAG3P,QAAQ,CAACC,IAAT,CAAc,4BAAd,CAAb;AACA0P,MAAAA,MAAM,CAACnN,EAAP,CAAU,YAAV,EAAwB,UAAC2H,KAAD,EAAW;AACjC/J,QAAAA,iBAAiB,CAACwP,uBAAlB,GAA4C,IAA5C;AACD,OAFD,EAGCpN,EAHD,CAGI,YAHJ,EAGkB,UAAC2H,KAAD,EAAW;AAC3B/J,QAAAA,iBAAiB,CAACwP,uBAAlB,GAA4C,KAA5C;AACD,OALD;AAOD;AACF;;AAED,WAAS3K,iBAAT,CAA2BH,KAA3B,EAAkC8C,GAAlC,EAAuCnE,GAAvC,EAA4C;AAC1C,QAAImE,GAAG,IAAInE,GAAP,IAAcqB,KAAlB,EAAyB;AACvB,UAAID,KAAK,GAAGpB,GAAG,GAAGmE,GAAlB;AACA,UAAIiI,UAAU,GAAIhL,KAAK,GAACC,KAAP,GAAgB,IAAjC;AACA,UAAIgL,MAAM,GAAG,QAAb;AACA,UAAIC,OAAO,GAAG,WAAd;;AAEA,UAAIF,UAAU,IAAI,EAAlB,EAAsB;AACpB,eAAO,UAAP;AACD;;AACD,UAAIA,UAAU,IAAI,IAAd,IAAsBhL,KAAK,IAAIiL,MAAnC,EAA2C;AACzC,eAAO,OAAP;AACD;;AACD,UAAID,UAAU,IAAI,KAAlB,EAAyB;AACvB,eAAO,aAAP;AACD;;AACD,UAAIA,UAAU,IAAI,OAAd,IAAyBhL,KAAK,IAAIkL,OAAtC,EAA+C;AAC7C,eAAO,OAAP;AACD;;AACD,aAAO,OAAP;AACD;;AAED,WAAO,OAAP;AACD;;qBAjsBuBzQ,I;;;;AAtBjBsD,MAAAA,C;;AACAuK,MAAAA,C;;AACAW,MAAAA,M;;AACAvF,MAAAA,G;;AACCqE,MAAAA,S,gBAAAA,S;AAAWvB,MAAAA,U,gBAAAA,U;;AACX2E,MAAAA,Q,sBAAAA,Q;AAAUC,MAAAA,iB,sBAAAA,iB;AAAmBC,MAAAA,e,sBAAAA,e;;AAC9B1L,MAAAA,E;;AACK0G,MAAAA,gB;;AACJ/K,MAAAA,oB,YAAAA,oB;;AACAE,MAAAA,iB,gBAAAA,iB;;;AAEJ6L,MAAAA,a,GAAgB,C;AAChBtD,MAAAA,c,GAAiB,C;AACjBC,MAAAA,c,GAAiB,C;AACjBC,MAAAA,U,GAAa,C;AACbxG,MAAAA,wB,GAA2B,G;AAC3ByC,MAAAA,sB,GAAyB,G;AACzBoL,MAAAA,sB,GAAyB,E;AACzBxK,MAAAA,mB,GAAsB,E;AACtB+B,MAAAA,mB,GAAsB,C;AACtB+F,MAAAA,mB,GAAsB,C","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment';\nimport kbn from 'app/core/utils/kbn';\nimport {appEvents, contextSrv} from 'app/core/core';\nimport {tickStep, getScaledDecimals, getFlotTickSize} from 'app/core/utils/ticks';\nimport d3 from 'd3';\nimport * as d3ScaleChromatic from './libs/d3-scale-chromatic/index';\nimport {StatusHeatmapTooltip} from './tooltip';\nimport {AnnotationTooltip} from './annotations';\n\nlet MIN_CARD_SIZE = 5,\n    CARD_H_SPACING = 2,\n    CARD_V_SPACING = 2,\n    CARD_ROUND = 0,\n    DATA_RANGE_WIDING_FACTOR = 1.2,\n    DEFAULT_X_TICK_SIZE_PX = 100,\n    DEFAULT_Y_TICK_SIZE_PX = 50,\n    X_AXIS_TICK_PADDING = 10,\n    Y_AXIS_TICK_PADDING = 5,\n    MIN_SELECTION_WIDTH = 2;\n\nexport default function link(scope, elem, attrs, ctrl) {\n  let data, cardsData, timeRange, panel, heatmap;\n\n  // $heatmap is JQuery object, but heatmap is D3\n  let $heatmap = elem.find('.status-heatmap-panel');\n  let tooltip = new StatusHeatmapTooltip($heatmap, scope);\n  let annotationTooltip = new AnnotationTooltip($heatmap, scope);\n\n  let width, height,\n      yScale, xScale,\n      chartWidth, chartHeight,\n      chartTop, chartBottom,\n      yAxisWidth, xAxisHeight,\n      cardVSpacing, cardHSpacing, cardRound,\n      cardWidth, cardHeight,\n      colorScale, opacityScale,\n      mouseUpHandler,\n      xGridSize, yGridSize;\n\n  let yOffset = 0;\n\n  let selection = {\n    active: false,\n    x1: -1,\n    x2: -1\n  };\n\n  let padding = {left: 0, right: 0, top: 0, bottom: 0},\n      margin = {left: 25, right: 15, top: 10, bottom: 20},\n      dataRangeWidingFactor = DATA_RANGE_WIDING_FACTOR;\n\n  ctrl.events.on('render', () => {\n    render();\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= panel.legend.show ? 32 : 10; // bottom padding and space for legend. Change margin in .status-heatmap-color-legend !\n\n      $heatmap.css('height', height + 'px');\n\n      return true;\n    } catch (e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function getYAxisWidth(elem) {\n    let axis_text = elem.selectAll(\".axis-y text\").nodes();\n    let max_text_width = _.max(_.map(axis_text, text => {\n      // Use SVG getBBox method\n      return text.getBBox().width;\n    }));\n\n    return Math.ceil(max_text_width);\n  }\n\n  function getXAxisHeight(elem) {\n    let axis_line = elem.select(\".axis-x line\");\n    if (!axis_line.empty()) {\n      let axis_line_position = parseFloat(elem.select(\".axis-x line\").attr(\"y2\"));\n      let canvas_width = parseFloat(elem.attr(\"height\"));\n      return canvas_width - axis_line_position;\n    } else {\n      // Default height\n      return 30;\n    }\n  }\n\n  function addXAxis() {\n    // Scale timestamps to cards centers\n    scope.xScale = xScale = d3.scaleTime()\n      .domain([timeRange.from, timeRange.to])\n      .range([xGridSize/2, chartWidth-xGridSize/2]);\n\n    let ticks = chartWidth / DEFAULT_X_TICK_SIZE_PX;\n    let grafanaTimeFormatter = grafanaTimeFormat(ticks, timeRange.from, timeRange.to);\n    let timeFormat;\n    let dashboardTimeZone = ctrl.dashboard.getTimezone();\n    if (dashboardTimeZone === 'utc') {\n      timeFormat = d3.utcFormat(grafanaTimeFormatter);\n    } else {\n      timeFormat = d3.timeFormat(grafanaTimeFormatter);\n    }\n\n    let xAxis = d3.axisBottom(xScale)\n      .ticks(ticks)\n      .tickFormat(timeFormat)\n      .tickPadding(X_AXIS_TICK_PADDING)\n      .tickSize(chartHeight);\n\n    let posY = chartTop;\n    let posX = yAxisWidth;\n\n    heatmap.append(\"g\")\n      .attr(\"class\", \"axis axis-x\")\n      .attr(\"transform\", \"translate(\" + posX + \",\" + posY + \")\")\n      .call(xAxis);\n\n    // Remove horizontal line in the top of axis labels (called domain in d3)\n    heatmap.select(\".axis-x\").select(\".domain\").remove();\n  }\n\n  // divide chart height by ticks for cards drawing\n  function getYScale(ticks) {\n    let range = [];\n    let step = chartHeight / ticks.length;\n    // svg has y=0 on the top, so top card should have a minimal value in range\n    range.push(step);\n    for (let i = 1; i < ticks.length; i++) {\n      range.push(step * (i+1));\n    }\n    return d3.scaleOrdinal()\n      .domain(ticks)\n      .range(range);\n  }\n\n  // divide chart height by ticks with offset for ticks drawing\n  function getYAxisScale(ticks) {\n    let range = [];\n    let step = chartHeight / ticks.length;\n    // svg has y=0 on the top, so top tick should have a minimal value in range\n    range.push(yOffset);\n    for (let i = 1; i < ticks.length; i++) {\n      range.push(step * i + yOffset);\n    }\n    return d3.scaleOrdinal()\n      .domain(ticks)\n      .range(range);\n  }\n\n  function addYAxis() {\n    let ticks = _.uniq(_.map(data, d => d.target));\n\n    // Set default Y min and max if no data\n    if (_.isEmpty(data)) {\n      ticks = [''];\n    }\n\n    if (panel.yAxisSort == 'a → z') {\n      ticks.sort((a, b) => a.localeCompare(b, 'en', {ignorePunctuation: false, numeric: true}));\n    } else if (panel.yAxisSort == 'z → a') {\n      ticks.sort((b, a) => a.localeCompare(b, 'en', {ignorePunctuation: false, numeric: true}));\n    }\n\n    let yAxisScale = getYAxisScale(ticks);\n    scope.yScale = yScale = getYScale(ticks);\n\n    let yAxis = d3.axisLeft(yAxisScale)\n      .tickValues(ticks)\n      .tickSizeInner(0 - width)\n      .tickPadding(Y_AXIS_TICK_PADDING);\n\n    heatmap.append(\"g\")\n      .attr(\"class\", \"axis axis-y\")\n      .call(yAxis);\n\n    // Calculate Y axis width first, then move axis into visible area\n    let posY = margin.top;\n    let posX = getYAxisWidth(heatmap) + Y_AXIS_TICK_PADDING;\n    heatmap.select(\".axis-y\").attr(\"transform\", \"translate(\" + posX + \",\" + posY + \")\");\n\n    // Remove vertical line in the right of axis labels (called domain in d3)\n    heatmap.select(\".axis-y\").select(\".domain\").remove();\n    heatmap.select(\".axis-y\").selectAll(\".tick line\").remove();\n  }\n\n  // Wide Y values range and adjust to bucket size\n  function wideYAxisRange(min, max, tickInterval) {\n    let y_widing = (max * (dataRangeWidingFactor - 1) - min * (dataRangeWidingFactor - 1)) / 2;\n    let y_min, y_max;\n\n    if (tickInterval === 0) {\n      y_max = max * dataRangeWidingFactor;\n      y_min = min - min * (dataRangeWidingFactor - 1);\n      tickInterval = (y_max - y_min) / 2;\n    } else {\n      y_max = Math.ceil((max + y_widing) / tickInterval) * tickInterval;\n      y_min = Math.floor((min - y_widing) / tickInterval) * tickInterval;\n    }\n\n    // Don't wide axis below 0 if all values are positive\n    if (min >= 0 && y_min < 0) {\n      y_min = 0;\n    }\n\n    return {y_min, y_max};\n  }\n\n  function tickValueFormatter(decimals, scaledDecimals = null) {\n    let format = panel.yAxis.format;\n    return function(value) {\n      return kbn.valueFormats[format](value, decimals, scaledDecimals);\n    };\n  }\n\n  // Create svg element, add axes and\n  // calculate sizes for cards drawing\n  function addHeatmapCanvas() {\n    let heatmap_elem = $heatmap[0];\n\n    width = Math.floor($heatmap.width()) - padding.right;\n    height = Math.floor($heatmap.height()) - padding.bottom;\n\n    if (heatmap) {\n      heatmap.remove();\n    }\n\n    heatmap = d3.select(heatmap_elem)\n      .append(\"svg\")\n      .attr(\"width\", width)\n      .attr(\"height\", height);\n\n    chartHeight = height - margin.top - margin.bottom;\n    chartTop = margin.top;\n    chartBottom = chartTop + chartHeight;\n\n    cardHSpacing = panel.cards.cardHSpacing !== null ? panel.cards.cardHSpacing : CARD_H_SPACING;\n    cardVSpacing = panel.cards.cardVSpacing !== null ? panel.cards.cardVSpacing : CARD_V_SPACING;\n    cardRound = panel.cards.cardRound !== null ? panel.cards.cardRound : CARD_ROUND;\n\n    // calculate yOffset for YAxis\n    yGridSize = Math.floor(chartHeight / cardsData.yBucketSize);\n    cardHeight = yGridSize ? yGridSize - cardVSpacing : 0;\n    yOffset = cardHeight / 2;\n\n    addYAxis();\n\n    yAxisWidth = getYAxisWidth(heatmap) + Y_AXIS_TICK_PADDING;\n    chartWidth = width - yAxisWidth - margin.right;\n\n    // TODO allow per-y cardWidth!\n    // we need to fill chartWidth with xBucketSize cards.\n    xGridSize = chartWidth / (cardsData.xBucketSize+1);\n    cardWidth = xGridSize - cardHSpacing;\n\n    addXAxis();\n    xAxisHeight = getXAxisHeight(heatmap);\n\n    if (!panel.yAxis.show) {\n      heatmap.select(\".axis-y\").selectAll(\"line\").style(\"opacity\", 0);\n    }\n\n    if (!panel.xAxis.show) {\n      heatmap.select(\".axis-x\").selectAll(\"line\").style(\"opacity\", 0);\n    }\n  }\n\n  function addHeatmap() {\n    addHeatmapCanvas();\n\n    let maxValue = panel.color.max || cardsData.maxValue;\n    let minValue = panel.color.min || cardsData.minValue;\n\n    if (panel.color.mode !== 'discrete') {\n      colorScale = getColorScale(maxValue, minValue);\n    }\n    setOpacityScale(maxValue);\n\n    let cards = heatmap.selectAll(\".status-heatmap-card\").data(cardsData.cards);\n    cards.append(\"title\");\n    cards = cards.enter().append(\"rect\")\n    .attr(\"cardId\", c => c.id)\n    .attr(\"x\", getCardX)\n    .attr(\"width\", getCardWidth)\n    .attr(\"y\", getCardY)\n    .attr(\"height\", getCardHeight)\n    .attr(\"rx\", cardRound)\n    .attr(\"ry\", cardRound)\n    .attr(\"class\", \"bordered status-heatmap-card\")\n    .style(\"fill\", getCardColor)\n    .style(\"stroke\", getCardColor)\n    .style(\"stroke-width\", 0)\n    //.style(\"stroke-width\", getCardStrokeWidth)\n    //.style(\"stroke-dasharray\", \"3,3\")\n    .style(\"opacity\", getCardOpacity);\n\n    let $cards = $heatmap.find(\".status-heatmap-card\");\n    $cards.on(\"mouseenter\", (event) => {\n      tooltip.mouseOverBucket = true;\n      highlightCard(event);\n    })\n    .on(\"mouseleave\", (event) => {\n      tooltip.mouseOverBucket = false;\n      resetCardHighLight(event);\n    });\n\n    _renderAnnotations();\n\n    ctrl.events.emit('render-complete', {\n      \"chartWidth\": chartWidth\n    });\n  }\n\n  function highlightCard(event) {\n    let color = d3.select(event.target).style(\"fill\");\n    let highlightColor = d3.color(color).darker(2);\n    let strokeColor = d3.color(color).brighter(4);\n    let current_card = d3.select(event.target);\n    tooltip.originalFillColor = color;\n    current_card.style(\"fill\", highlightColor)\n    .style(\"stroke\", strokeColor)\n    .style(\"stroke-width\", 1);\n  }\n\n  function resetCardHighLight(event) {\n    d3\n      .select(event.target)\n      .style(\"fill\", tooltip.originalFillColor)\n      .style(\"stroke\", tooltip.originalFillColor)\n      .style(\"stroke-width\", 0);\n  }\n\n  function getColorScale(maxValue, minValue = 0) {\n    let colorScheme = _.find(ctrl.colorSchemes, {value: panel.color.colorScheme});\n    let colorInterpolator = d3ScaleChromatic[colorScheme.value];\n    let colorScaleInverted = colorScheme.invert === 'always' ||\n      (colorScheme.invert === 'dark' && !contextSrv.user.lightTheme);\n\n    if (maxValue == minValue)\n      maxValue = minValue + 1;\n\n    let start = colorScaleInverted ? maxValue : minValue;\n    let end = colorScaleInverted ? minValue : maxValue;\n\n    return d3.scaleSequential(colorInterpolator).domain([start, end]);\n  }\n\n  function setOpacityScale(maxValue) {\n    if (panel.color.colorScale === 'linear') {\n      opacityScale = d3.scaleLinear()\n      .domain([0, maxValue])\n      .range([0, 1]);\n    } else if (panel.color.colorScale === 'sqrt') {\n      opacityScale = d3.scalePow().exponent(panel.color.exponent)\n      .domain([0, maxValue])\n      .range([0, 1]);\n    }\n  }\n\n  function getCardX(d) {\n    let x;\n    // cx is the center of the card. Card should be placed to the left.\n    let cx = xScale(d.x);\n\n    if (cx - cardWidth/2 < 0) {\n      x = yAxisWidth + cardHSpacing/2;\n    } else {\n      x = yAxisWidth + cx - cardWidth/2;\n    }\n\n    return x;\n  }\n\n  // xScale returns card center. Adjust cardWidth in case of overlaping.\n  function getCardWidth(d) {\n    let w;\n    let cx = xScale(d.x);\n\n    if (cx < cardWidth/2) {\n      // Center should not exceed half of card.\n      // Cut card to the left to prevent overlay of y axis.\n      let cutted_width = (cx - cardHSpacing/2) + cardWidth/2;\n      w = cutted_width > 0 ? cutted_width : 0;\n    } else if (chartWidth - cx < cardWidth/2) {\n      // Cut card to the right to prevent overlay of right graph edge.\n      w = cardWidth/2 + (chartWidth - cx - cardHSpacing/2);\n    } else {\n      w = cardWidth;\n    }\n\n    // Card width should be MIN_CARD_SIZE at least\n    w = Math.max(w, MIN_CARD_SIZE);\n\n    if (cardHSpacing == 0) {\n      w = w+1;\n    }\n\n    return w;\n  }\n\n  function getCardY(d) {\n    return yScale(d.y) + chartTop - cardHeight - cardVSpacing/2;\n  }\n\n  function getCardHeight(d) {\n    let ys = yScale(d.y);\n    let y = ys + chartTop - cardHeight - cardVSpacing/2;\n    let h = cardHeight;\n\n    // Cut card height to prevent overlay\n    if (y < chartTop) {\n      h = ys - cardVSpacing/2;\n    } else if (ys > chartBottom) {\n      h = chartBottom - y;\n    } else if (y + cardHeight > chartBottom) {\n      h = chartBottom - y;\n    }\n\n    // Height can't be more than chart height\n    h = Math.min(h, chartHeight);\n    // Card height should be MIN_CARD_SIZE at least\n    h = Math.max(h, MIN_CARD_SIZE);\n\n    if (cardVSpacing == 0) {\n      h = h+1\n    }\n\n    return h;\n  }\n\n  function getCardColor(d) {\n    if (panel.color.mode === 'opacity') {\n      return panel.color.cardColor;\n    } else if (panel.color.mode === 'spectrum') {\n      return colorScale(d.value);\n    } else if (panel.color.mode === 'discrete') {\n      return ctrl.discreteHelper.getBucketColor(d.values);\n    }\n  }\n\n  function getCardOpacity(d) {\n    if (panel.nullPointMode === 'as empty' && d.value == null ) {\n      return 0;\n    }\n    if (panel.color.mode === 'opacity') {\n      return opacityScale(d.value);\n    } else {\n      return 1;\n    }\n  }\n\n  function getCardStrokeWidth(d) {\n    if (panel.color.mode === 'discrete') {\n      return '1';\n    }\n    return '0';\n  }\n\n  /////////////////////////////\n  // Selection and crosshair //\n  /////////////////////////////\n\n  // Shared crosshair and tooltip\n  appEvents.on('graph-hover', event => {\n    drawSharedCrosshair(event.pos);\n  }, scope);\n\n  appEvents.on('graph-hover-clear', () => {\n    clearCrosshair();\n  }, scope);\n\n  function onMouseDown(event) {\n    selection.active = true;\n    selection.x1 = event.offsetX;\n\n    mouseUpHandler = function() {\n      onMouseUp();\n    };\n\n    $(document).one(\"mouseup\", mouseUpHandler);\n  }\n\n  function onMouseUp() {\n    $(document).unbind(\"mouseup\", mouseUpHandler);\n    mouseUpHandler = null;\n    selection.active = false;\n\n    let selectionRange = Math.abs(selection.x2 - selection.x1);\n    if (selection.x2 >= 0 && selectionRange > MIN_SELECTION_WIDTH) {\n      let timeFrom = xScale.invert(Math.min(selection.x1, selection.x2) - yAxisWidth - xGridSize/2);\n      let timeTo = xScale.invert(Math.max(selection.x1, selection.x2) - yAxisWidth - xGridSize/2);\n\n      ctrl.timeSrv.setTime({\n        from: moment.utc(timeFrom),\n        to: moment.utc(timeTo)\n      });\n    }\n\n    clearSelection();\n  }\n\n  function onMouseLeave() {\n    appEvents.emit('graph-hover-clear');\n    clearCrosshair();\n    //annotationTooltip.destroy();\n  }\n\n  function onMouseMove(event) {\n    if (!heatmap) { return; }\n\n    if (selection.active) {\n      // Clear crosshair and tooltip\n      clearCrosshair();\n      tooltip.destroy();\n      annotationTooltip.destroy();\n\n      selection.x2 = limitSelection(event.offsetX);\n      drawSelection(selection.x1, selection.x2);\n    } else {\n      emitGraphHoverEvet(event);\n      drawCrosshair(event.offsetX);\n      tooltip.show(event); //, data);\n      annotationTooltip.show(event);\n    }\n  }\n\n  function emitGraphHoverEvet(event) {\n    let x = xScale.invert(event.offsetX - yAxisWidth - xGridSize/2).valueOf();\n    let y = yScale(event.offsetY);\n    let pos = {\n      pageX: event.pageX,\n      pageY: event.pageY,\n      x: x, x1: x,\n      y: y, y1: y,\n      panelRelY: null\n    };\n\n    // Set minimum offset to prevent showing legend from another panel\n    pos.panelRelY = Math.max(event.offsetY / height, 0.001);\n\n    // broadcast to other graph panels that we are hovering\n    appEvents.emit('graph-hover', {pos: pos, panel: panel});\n  }\n\n  function limitSelection(x2) {\n    x2 = Math.max(x2, yAxisWidth);\n    x2 = Math.min(x2, chartWidth + yAxisWidth);\n    return x2;\n  }\n\n  function drawSelection(posX1, posX2) {\n    if (heatmap) {\n      heatmap.selectAll(\".status-heatmap-selection\").remove();\n      let selectionX = Math.min(posX1, posX2);\n      let selectionWidth = Math.abs(posX1 - posX2);\n\n      if (selectionWidth > MIN_SELECTION_WIDTH) {\n        heatmap.append(\"rect\")\n        .attr(\"class\", \"status-heatmap-selection\")\n        .attr(\"x\", selectionX)\n        .attr(\"width\", selectionWidth)\n        .attr(\"y\", chartTop)\n        .attr(\"height\", chartHeight);\n      }\n    }\n  }\n\n  function clearSelection() {\n    selection.x1 = -1;\n    selection.x2 = -1;\n\n    if (heatmap) {\n      heatmap.selectAll(\".status-heatmap-selection\").remove();\n    }\n  }\n\n  function drawCrosshair(position) {\n    if (heatmap) {\n      heatmap.selectAll(\".status-heatmap-crosshair\").remove();\n\n      let posX = position;\n      posX = Math.max(posX, yAxisWidth);\n      posX = Math.min(posX, chartWidth + yAxisWidth);\n\n      heatmap.append(\"g\")\n      .attr(\"class\", \"status-heatmap-crosshair\")\n      .attr(\"transform\", \"translate(\" + posX + \",0)\")\n      .append(\"line\")\n      .attr(\"x1\", 1)\n      .attr(\"y1\", chartTop)\n      .attr(\"x2\", 1)\n      .attr(\"y2\", chartBottom)\n      .attr(\"stroke-width\", 1);\n    }\n  }\n\n  // map time to X\n  function drawSharedCrosshair(pos) {\n    if (heatmap && ctrl.dashboard.graphTooltip !== 0) {\n      let posX = xScale(pos.x) + yAxisWidth;\n      drawCrosshair(posX);\n    }\n  }\n\n  function clearCrosshair() {\n    if (heatmap) {\n      heatmap.selectAll(\".status-heatmap-crosshair\").remove();\n    }\n  }\n\n  function render() {\n    data = ctrl.data;\n    panel = ctrl.panel;\n    timeRange = ctrl.range;\n    cardsData = ctrl.cardsData;\n\n    if (!data || !cardsData || !setElementHeight()) {\n      return;\n    }\n\n    // Draw default axes and return if no data\n    if (_.isEmpty(cardsData.cards)) {\n      addHeatmapCanvas();\n      return;\n    }\n\n    addHeatmap();\n    scope.yAxisWidth = yAxisWidth;\n    scope.xAxisHeight = xAxisHeight;\n    scope.chartHeight = chartHeight;\n    scope.chartWidth = chartWidth;\n    scope.chartTop = chartTop;\n  }\n\n  // Register selection listeners\n  $heatmap.on(\"mousedown\", onMouseDown);\n  $heatmap.on(\"mousemove\", onMouseMove);\n  $heatmap.on(\"mouseleave\", onMouseLeave);\n\n  function _renderAnnotations() {\n    if (!ctrl.annotations || ctrl.annotations.length == 0) {\n      return;\n    }\n  \n    if (!heatmap) {\n      return;\n    }\n\n    let annoData = _.map(ctrl.annotations, (d,i) => ({\"x\": Math.floor(yAxisWidth + xScale(d.time)), \"id\":i, \"anno\": d.source}));\n\n\n    let anno = heatmap\n      .append(\"g\")\n      .attr(\"class\", \"statusmap-annotations\")\n      .attr(\"transform\", \"translate(0.5,0)\")\n      .selectAll(\".statusmap-annotations\")\n      .data(annoData)\n      .enter().append(\"g\")\n      ;\n    anno.append(\"line\")\n      //.attr(\"class\", \"statusmap-annotation-tick\")\n      .attr(\"x1\", d => d.x)\n      .attr(\"y1\", chartTop)\n      .attr(\"x2\", d => d.x)\n      .attr(\"y2\", chartBottom)\n      .style(\"stroke\", d => d.anno.iconColor)\n      .style(\"stroke-width\", 1)\n      .style(\"stroke-dasharray\", \"3,3\")\n    ;\n    anno.append(\"polygon\")\n      .attr(\"points\", d => [[d.x, chartBottom+1], [d.x-5, chartBottom+6], [d.x+5, chartBottom+6]].join(\" \"))\n      .style(\"stroke-width\", 0)\n      .style(\"fill\", d => d.anno.iconColor)\n    ;\n    // Polygons didn't fire mouseevents\n    anno.append(\"rect\") \n      .attr(\"x\", d => d.x-5)\n      .attr(\"width\", 10)\n      .attr(\"y\", chartBottom+1)\n      .attr(\"height\", 5)\n      .attr(\"class\", \"statusmap-annotation-tick\")\n      .attr(\"annoId\", d => d.id)\n      .style(\"opacity\", 0)\n    ;\n\n    let $ticks = $heatmap.find(\".statusmap-annotation-tick\");\n    $ticks.on(\"mouseenter\", (event) => {\n      annotationTooltip.mouseOverAnnotationTick = true;\n    })\n    .on(\"mouseleave\", (event) => {\n      annotationTooltip.mouseOverAnnotationTick = false;\n    });\n    \n  }\n}\n\nfunction grafanaTimeFormat(ticks, min, max) {\n  if (min && max && ticks) {\n    let range = max - min;\n    let secPerTick = (range/ticks) / 1000;\n    let oneDay = 86400000;\n    let oneYear = 31536000000;\n\n    if (secPerTick <= 45) {\n      return \"%H:%M:%S\";\n    }\n    if (secPerTick <= 7200 || range <= oneDay) {\n      return \"%H:%M\";\n    }\n    if (secPerTick <= 80000) {\n      return \"%m/%d %H:%M\";\n    }\n    if (secPerTick <= 2419200 || range <= oneYear) {\n      return \"%m/%d\";\n    }\n    return \"%Y-%m\";\n  }\n\n  return \"%H:%M\";\n}\n"],"file":"rendering.js"}